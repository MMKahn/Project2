---
title: "ST 558 Project 2"
author: "Melanie Kahn & Bennett McAuley"
output:
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(jsonlite)
library(tidyverse)
```


## Overview

The purpose and overall goal of this vignette is to instruct the user on how to contact an API using functions we created to query, parse, and return data in a well-structured format. These functions drive a basic exploratory analysis.

This vignette makes use of the beer data API by the [Open Brewery DB](https://www.openbrewerydb.org/faq) project.

## Requirements

The following packages are required to run the code properly:

- `httr`
- `jsonlite`
- `tidyverse`

## The Data

This section provides the context and structure of the data to get a better understanding of the contents of the API.

The brewery data from Open Brewery DB features information on breweries, cideries, brewpubs, and bottleshops around the world. Using the `GET` function from the `httr` package, a list of breweries is returned.

```{r}
library(httr)
breweries <- GET("https://api.openbrewerydb.org/breweries")
str(breweries, max.level = 1)
```

This information isn't very readable, so we will parse it using the `FromJSON` function from the `jsonlite` package, and represent the information as a tibble.

```{r}
brew_parsed <- fromJSON(rawToChar(breweries$content))
as_tibble(brew_parsed)
```

The variables present for each entry in this database are as follows:

- `id` - The unique ID of the brewery
- `name` - The name of the brewery
- `brewery_type` - The type of brewery; must be one of:
  - `micro` - Most craft breweries
  - `nano` - An extremely small brewery that typically only distributes locally
  - `regional` - Regional location of an expanded brewery
  - `brewpub` - A beer-focused restaurant or bar with a brewery on-premise
  - `planning` - A brewery in planning or not yet opened to the public
  - `contract` - A brewery that uses another brewery's equipment
  - `proprietor` - Similiar to contract brewing but refers more to a brewery incubator
  - `closed` - A location that has closed
- `street` - The street address of the brewery
- `address_2` - 
- `address_3`
- `city`
- `state`
- `county_province`
- `postal_code`
- `country`
- `longitude` - The vertical distance from an origin point
- `latitude` - The horizontal distance from an origin point
- `phone`
- `website_url`
- `updated_at`
- `created_at`

Notice that some of the variables provide useful information that can be applied to data analysis; some cannot. This will be addressed by the functions (_see below_) that will query the data and return tibbles that are analysis-ready.

[Back to Top](#top)

## Function Definitions

This section is dedicated to showcasing all of the functions go into contacting the API, querying data, and performing our basic exploratory analysis.

### Get_OB_DataFrame

The `Get_OB_DataFrame` function contacts the API, runs a query based on values provided by the user, parses the data from the query, and returns a tibble with relevant and well-formatted variables. It takes the following arguments:

- `size` - The number of breweries to return as observations
- `search_by` - The category of filtering to be applied to the search. Valid options are `"city"`, `"state"`, `"country"`, `"type"` (_for `brewery_type`, see above for values_), and `"name"`
- `input` - The value or term to be searched for

_Note: In testing, it was discovered that the querying functionality is not case sensitive (i.e. `"raleigh"`, `"Raleigh"`, and `"RALEIGH"` will all return the same thing), so inputting the values in sentence case is not necessary. Inputting them in quotations on function call, however, is._

```{r API contact}
Get_OB_DataFrame <- function(size, search_by, input) {
  if (search_by %in% c("city", "state", "country", "type", "name")) {
    query <- GET(paste0("https://api.openbrewerydb.org/breweries?by_", search_by, "=", input, "&per_page=", size))
  } else {
    stop("Invalid search category. Please use one of these options: 'city', 'state', 'country', 'type' or 'name'.")
  }

  query_parse <- fromJSON(rawToChar(query$content))
  
  dt <- as_tibble(query_parse) %>%
    select(id, name, brewery_type, street, city, state, county_province, country) %>%
    arrange(name)
  
  return(dt)
}
```

[Back to Top](#top)

### Get_OB_Random

`Get_OB_Random` is functionally identical to `Get_OB_DataFrame`, but instead of the user specifying characteristics they want in the data, the observations are queried at random based on the following argument:

- `n` - The number of breweries to return as observations (default is `5`). According to the API documentation, the maximum is `50`.

_Note: In testing, it was verified that the randomness in the API is not really random; there is a seed associated with it as the queries yielded the same results per value of `n`, regardless of whether a seed was speicifed in the R environment._

```{r Random}
Get_OB_Random <- function(n = 5) {
  
  query <- GET(paste0("https://api.openbrewerydb.org/breweries/random?size=", n))

  query_parse <- fromJSON(rawToChar(query$content))
  
  dt <- as_tibble(query_parse) %>%
    select(id, name, brewery_type, street, city, state, county_province, country) %>%
    arrange(name)
  
  return(dt)
}
```
[Back to Top](#top)

## Exploratory Data Analysis


